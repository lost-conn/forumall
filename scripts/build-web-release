#!/bin/bash
set -e

# Build release archive for Forumall server and web client
# Output: forumall-release.tar.gz

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$PROJECT_ROOT"

BUILD_DIR="$PROJECT_ROOT/build-release"
ARCHIVE_NAME="forumall-release.tar.gz"

echo "=== Building Forumall Release ==="

# Clean previous build
rm -rf "$BUILD_DIR"
mkdir -p "$BUILD_DIR"

# Build server
echo ""
echo "Building server..."
cargo build -p forumall-server --release

# Build web client
echo ""
echo "Building web client..."
cd crates/client
dx build --release --platform web
cd "$PROJECT_ROOT"

# Copy server binary
echo ""
echo "Copying server binary..."
cp target/release/forumall-server "$BUILD_DIR/"

# Copy web client
echo ""
echo "Copying web client..."
cp -r target/dx/forumall-client/release/web/public "$BUILD_DIR/web"

# Create archive
echo ""
echo "Creating archive..."
tar -czvf "$ARCHIVE_NAME" -C "$BUILD_DIR" .

# Cleanup
rm -rf "$BUILD_DIR"

# Show result
echo ""
echo "=== Build complete ==="
echo "Archive: $ARCHIVE_NAME"
echo "Size: $(du -h "$ARCHIVE_NAME" | cut -f1)"
echo ""
echo "Contents:"
tar -tzvf "$ARCHIVE_NAME"
